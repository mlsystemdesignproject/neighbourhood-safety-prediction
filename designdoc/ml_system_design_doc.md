# ML System Design Doc - Neighbourhood Safety Prediction [RU]
## Дизайн ML системы – Прогнозирование уровня безопасности в районах Лондона

### 1. Цели и предпосылки
#### 1.1. Обоснованность разработки продукта

##### Бизнес цель
Бизнес цель – разработка ML модели, которая будет точно прогнозировать уровень безопасности в районах Лондона на следующие 6 месяцев. Прогнозы будут использоваться для:
- принятия решений по управлению безопасностью в районах
- информированности жителей об уровне безопасности в определенном районе 

##### Побочная бизнес цель
Побочная бизнес цель – повышение уровня безопасности в районах Лондона за счет более эффективного распределения ресурсов и информирования жителей.

##### Описание текущего бизнес-процесса
В настоящее время исторический уровень безопасности в районах Лондона можно оценить из данных различных источников, включая:
- отчеты полиции
- данные о преступности

##### Польза от внедрения ML модели
Внедрение ML модели позволит прогнозировать уровень безопасности в районах Лондона. Это будет способствовать повышению эффективности управления безопасностью и повышению уровня безопасности в целом.

##### Критерии успеха ML модели:
- Точность прогнозов должна быть ….. *(DS)*
- Прогнозы должны быть полезны для принятия решений по управлению безопасностью.

#### 1.2. Бизнес требования и ограничения
##### Целевое видение
- Необходимо делать предсказания уровня безопасности на 6 *(??? team meeting @Sun)* следующих месяцев. Прогнозы получать раз в месяц до последнего числа месяца 
- Гранулярность расчёта – отдельный borough, преступления за месяц
- Разбивка на различного вида преступления *(сколько?)* категорий
- Исторические данные загружаются *(как часто?)*
- Создание дашборда визуализации предсказаний модели *(требования?)*

##### Бизнес-требования и ограничения для пилота
- Необходимо cделать предсказания уровня безопасности на 6 следующих месяцев до конца декабря.
- Гранулярность расчёта – отдельный borough, преступления за месяц
- Предсказываются различного вида преступления *(сколько?)* категорий

##### Проведение пилота
- Тестирование модели и оценка пилота будут проводится на открытых данных Лондонской Полиции и агрегированых *(???)* данных социальных эвентов Лондона. 

#### 1.3. Что входит в скоуп итерации, а что нет
*(DS)*
- будет ли CI/CD?
- будет ли этап автоматического переобучения модели на новых данных?
- будет ли модель автоматически выкладываться в dockerhub?

#### 1.4. Предпосылки решения
*(DS)*
- Проект ведётся в GitHub
- Документация – google docs на google disc *(??? DS)*. Должна содержать описание алгоритма, результаты промежуточных тестов *(??? DS)*
- Код. В JupyterLab, соответствует PEP8, разбит на модули (??? DS) 
- Стек: *(?где?? DS)*
- БД: *(?что?? DS)*

### 2. Методология
[Здесь должно быть описание методологии, используемой для разработки ML модели. Можно упомянуть методы предобработки данных, выбора модели, обучения и оценки. - *(DS)*]

#### 2.1. Постановка задачи
- Создание прогнозной модели, задача регрессии с несколькими выходами (multi-output regression) для временных рядов.

#### 2.2. Блок схема

#### 2.3. Вехи (ключевые временные этапы) разработки решения задачи 

> Описания того, как шло развитие проекта во времени
##### 2.3.1 Milestone 1. Первичное знакомство с задачей/данными и разработка dummy реализации сервиса 

**Цель вехи.** Первичное знакомство с задачей, ее постановкой, возможными проблемами в:
- структуре данных, 
- обновляемости данных,
- постановке бизнес задачи, 
- достижимости/проверяемости бизнес метрик,
- реализуемости модели,
- реализуемости сервиса.

##### 2.3.1.1 Рассматриваем задачу возможные подходы к ее решению 
Цель проекта: предоставление прогноза безопасности районов Лондона.

Естественное предположение - сделать прогноз возможных преступлений в каждом районе города.
 
> Заказчиком заявлено требование предоставление данной информации на 6 месяцев. Но в формулировке отсутствует временные требования, так как они зависят от многих дополнительных факторов. Формулировка будет уточняться в процессе знакомства с возможными источниками данных и результатами моделирования (исследовательская фаза).

> Подходы и ключевые идеи заносятся в документ assumptions.md
##### 2.3.1.2 Первичные поиск источников данных 
Для нашего проекта выбраны данные о ежедневной преступности в районах Лондона [данные от MPS][MPS].
Отметим, что данные поступают с задержкой в 1.5 - 2 месяца. Данная задержка приводит к требованию горизонта планирования от 60 и более дней. 

Риски: возможность составления прогноза на 60 и более дней. 
Риски: как переходить к безопасности районов от уровня преступлений?

> Описание особенностей датасетов заносятся в документ assumptions.md

[MPS]: https://data.london.gov.uk/dataset/mps-monthly-crime-dahboard-data?_gl=1%2Ay2auo%2A_ga%2ANzk1NDE0ODM5LjE2OTI1MjU4NjU.%2A_ga_PY4SWZN1RJ%2AMTY5MjUyNTg2NC4xLjAuMTY5MjUyNTg2Ny42MC4wLjA
##### 2.3.1.3 Формулирование идей и предположений для этапа исследование 
Сама природа объекта исследования, не позволяет делать точных прогнозов и приводит к тому, что метриками модели должны быть (уточнения от Оксаны)

Надо выбрать/ограничить рассматриваемое число преступлений, в зависимости от бизнес запроса.  

> Идеи и предположения заносятся в документ assumptions.md
##### 2.3.1.4 Выбор датасета и преобразование данных
В качестве данных будут использоваться [данные от MPS][MPS] о ежедневной преступности в районах Лондона.

**Задача:** Регрессия с несколькими выходами (multi-output regression) для временных рядов.

**Каждая строка таблицы** будет соответствовать одному дню.

**Признаки:**
- Районы будут закодированы OneHotEncoder-ом, 
- следующие столбцы будут удалены: `Area Type`, `Area Name`, `Area Code`, `Financial Year`, `FY_FYIndex`

**Целевые значения (target):**
- каждая пара `{Crime Type, Crime Subtype}` формирует размерность (dimension) изучаемого пространства, а значение для этой размерности определяется величиной `Count` (число преступлений вида `{Crime Type, Crime Subtype}`)

**Риски:** число пар `{Crime Type, Crime Subtype}` в статистике [MPS][MPS] равно = XX, что сильно усложняет задачу. Далее выберем существенные для проекта пары `{Crime Type, Crime Subtype}`. 

> Привести список выбранных пар

##### 2.3.1.5  Проведение первичного EDA, dummy вариант решения задачи 

**Исследовательский анализ данных:**
- Исследование датасета, средние характеристики, разброс и распределения преступлений во времени. 
- уточнить про `Measure = {offences,Outcomes,Statistics}` в [данные от MPS][MPS]
- Выбрать существенный набор преступлений для данного проекта, то есть пары:
`{Crime Type, Crime Subtype}`.

**Выбор метрики для модели**  (уточнения от Оксаны)

**В качестве модели будем использовать** скользящее среднее?

##### 2.3.1.6 Обучение модели и валидация на отложенных тестовых данных
- Обучение и валидация модели на отложенных тестовых данных. 
- Демонстрация работы модели в jupyter notebook.

##### 2.3.1.7 Оформление простого интерфейса в Streamlit для модели
В рамках работы с интерфейсом, можно будет осуществить:
- выбор одного из 32 районов города Лондон,
- выбор даты/недели из возможного списка,

В ответ для каждого из вида преступлений (в 2.3.1.5 был выбран узкий список, существенный для проекта) должно выводится:
- номер недели,
- 7 векторов,
- каждый вектор - это оценка числа выбранных преступлений в данный день.



##### 2.3.2 Milestone 2 Исследование и baseline сервис

**Цель Вехи.** Исследование бизнес задачи и выбор: 
- дополнительных данных, которые могут улучшить прогноз,
- признаков(фичей),
- гранулярности данных (временного шага),
- метрики оценки бизнес эффекта (иерархия метрик),
- ML модели задачи,
- процедуры сравнения/обновления моделей, 
- ... [вопросы с сервисной реализацией(???) и проверкой изменений в данных(???)]. 

##### 2.3.2.1 Дополнительные данные для гипотез

Поиск данных для гипотез из файла assumptions, например:
- Выбор регулярных событий социальных событий, которые могу влиять на число преступлений в одном из районов Лондона в этот день футбольные матчи на крупных стадионах, концерты собирающие более 10'000 человек.
- Разбор важности редких мероприятий, таких как ежегодные события или события посвященные Королевской семье. 

В качестве источников возможны:
- актуальных данные о районах в Лондоне,
- данные социальных исследований и прогнозов,
- данные исследований природы преступлений Лондона и UK,
- веб скрепинг данных о социально значимых событиях Лондона с сайтов.

##### 2.3.2.2 Проверка гипотез

##### 2.3.2.3 Выбор дополнительных данных для модели

> Итоговый выбор согласованный с заказчиком. 

##### 2.3.2.4 EDA новых моделей и данных

##### 2.3.2.5  Выбор ключевых метрик и построение модели 
> Метрики ошибки/успешности модели.
> Метрики оценки изменения в данных для выбранных датасетов.

##### 2.3.2.6 Выбор новых/дополнительных временных фичей 
> какие из набора временных фичей лучше подойду:
> - лаги (lags),
> - тригонометрические (sin, cos),
> - выходные/будни, 
> - ???

##### 2.3.2.7 Описать процесс обновления модели

##### 2.3.2.7 Перевод из оценки числа преступлений в уровень безопасности
> Как осуществить перенос числа преступлений в районах города в уровень безопасности.

##### 2.3.2.8 Выбор способа реализации Baseline модели
> описать выбор ключевых инструментов

##### 2.3.2.9 Реализация Baseline модели

В рамках работы с интерфейсом, можно будет осуществить:
- выбор одного из 32 районов города Лондон,
- выбор даты/недели из возможного списка,

В ответ для каждого из вида преступлений (в 2.3.1.5 был выбран узкий список, существенный для проекта) должно выводится:
- среднее число преступлений в день для выбранной недели
- оценка дисперсии. 

##### 2.3.3 Milestone 3 Реализация MVP сервиса

**Цель Вехи.** Реализация:
- пайплайнов данных и моделей согласно M2,
- сервисной части проекта,
- мониторинга работы модели.  


#### 2.4. Этапы разработки решения задачи 

> Пока формулировки слишком шаблонные и будут уточнять в процессе работы над проектом

##### 2.4.1 Этап 1. Сбор данных 
> Вариант для natural отличается от baseline/MVP отличается.

Объединение данных от MPS и дополнительных источников данных.

>Набор дополнительных данных будет определен в рамках исследований (milestone 2).
> Источниками дополнительных данных являются:
> - актуальные данных о районах Лондона,
> - новые данные социальных исследований и прогнозов,
> - новые данные исследований природы преступлений Лондона и UK,
> - веб скрепинг данных о социально значимых событиях с сайтов.
 
##### 2.4.2 Этап 2. Анализ и подготовка данных и их обновлений.

Почистить и свести данные в одну таблицу.

> Для baseline и MVP отличается
> Привести список дополнительных данных и выбранных преступлений для прогноза

Риски: Если меняется бизнес задача, может меняться набор преступлений для прогноза 

##### 2.4.3 Этап 3. Обучение прогнозных моделей

> Для baseline и MVP отличается

> для MVP указать, как идет подбор параметров для Gridsearch  (Cross-Validation strategies for Time Series forecasting)

##### 2.4.4 Этап 4. Оценка модели 
> что делать, если модель стала сильно хуже предсказывать на новом наборе данных, надо проводить исследование для поиска новых признаков (фичей)

##### 2.4.5 Этап 5. Перевод в уровень безопасности модели

##### 2.4.6 Этап 6. - Считаем системные требования к модели. 

##### 2.4.7 Этап 7. - Утверждение метрик пилота.

##### 2.4.8 Этап 8. - Подготовка модели к деплою.
- Подготовить Docker 
- Выложить модель на DockerHub

##### 2.4.9 Этап 9. - Деплой 
- Yandex Cloud + kubernetes.
- Оценка стоимости 1 часа / 1 месяца работы инфраструктуры.

##### 2.4.10 Этап 10. - Мониторинг
- Развернуть Prometheus и Grafana стек.

#### 3. Затраты на внедрение проекта
Затраты на внедрение проекта включают затраты на разработку модели и внедрение модели в эксплуатацию.

#### *(??? какой пункт?)* Дизайн ML системы
ML модель будет построена на основе регрессионной *(??? DS)* модели. В качестве входных данных для модели будут использоваться данные из следующих источников:
- Данные о преступности
- Данные о социальных эвентах района 
- Погодные данные *(???)*

#### Выводы
Разработка ML модели для прогнозирования уровня безопасности в районах Лондона является перспективным направлением. Внедрение такой модели позволит более точно прогнозировать уровень безопасности, что будет способствовать повышению эффективности управления безопасностью и повышению уровня безопасности в целом.

#### Дополнительные рекомендации
В документ можно включить следующие дополнительные сведения:
- Подробное описание регрессионной модели, которая будет использоваться для прогнозирования уровня безопасности.
- План сбора данных для ML модели.
- План внедрения ML модели в эксплуатацию.
- Оценка экономической эффективности ML модели.
